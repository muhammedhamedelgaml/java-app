@Library('my-shared-lib@') _

node {
    def IMAGE_NAME = 'muhammedhamedelgaml/iti-java'
    def IMAGE_TAG = "v${BUILD_NUMBER}"
    def DOCKER_CRED_ID = credentials('dockerhub-pass')

    def mavenHome = tool name: 'maven', type: 'maven'
    def javaHome = tool name: 'jdk', type: 'jdk'
    
    
        stage("Checkout") {
        checkout scmGit(branches: [[name: '*/master']], extensions: [], userRemoteConfigs: [[url: 'https://github.com/muhammedhamedelgaml/java-app.git']])        }
        
        stage("Build App") {
        env.JAVA_HOME = javaHome
        env.PATH = "${javaHome}/bin:${mavenHome}/bin:${env.PATH}"
            def mavenBuild = new org.iti.mvn()
            mavenBuild.javaBuild("package install")
        }
        
        stage("Archive App") {
            archiveArtifacts artifacts: '**/*.jar', followSymlinks: false
        }
        
        stage("Docker Build") {
            def docker = new com.iti.docker()
            docker.build(IMAGE_NAME, IMAGE_TAG)
        }

        stage('Docker login') {
            steps {
                // def docker = new com.iti.docker()
                // docker.login( "muhammedhamedelgaml", "${DOCKER_CRED_ID}")
        //    sh "echo ${DOCKER_CRED_ID} | docker login -u "muhammedhamedelgaml" --password-stdin"
            sh "docker login -u muhammedhamedelgaml -p ${DOCKER_CRED_ID}"

            }
        }

  stage() {
    steps {
        script {
            def docker = new com.iti.docker(this)
            docker.push(IMAGE_NAME, IMAGE_TAG)
        }
    }

}

    // stage("push java app image"){
    //     sh "cd argocd"
    //     sh "sed -i #        image: muhammedhamed/java:v1#        image: iti-java:${BUILD_NUMBER}# iti-dev/deployment.yaml"
    // }


  
}
