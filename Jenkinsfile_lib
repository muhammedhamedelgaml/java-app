@Library('my-shared-lib@') _

node {
    def USERNAME = 'muhammedhamedelgaml'
    def IMAGE_NAME = 'muhammedhamedelgaml/iti-java'
    def IMAGE_TAG = "v${BUILD_NUMBER}"
    def DOCKER_CRED_ID = credentials('dockerhub-pass')

    def mavenHome = tool name: 'maven', type: 'maven'
    def javaHome = tool name: 'jdk', type: 'jdk'
    
    
        stage("Checkout") {
        checkout scmGit(branches: [[name: '*/master']], extensions: [], userRemoteConfigs: [[url: 'https://github.com/muhammedhamedelgaml/java-app.git']])        }
        
        stage("Build App") {
        env.JAVA_HOME = javaHome
        env.PATH = "${javaHome}/bin:${mavenHome}/bin:${env.PATH}"
            def mavenBuild = new org.iti.mvn()
            mavenBuild.javaBuild("package install")
        }
        
        stage("Archive App") {
            archiveArtifacts artifacts: '**/*.jar', followSymlinks: false
        }
        
        stage("Docker Build") {
            def docker = new com.iti.docker()
            docker.build(IMAGE_NAME, IMAGE_TAG)
        }

  stage('Docker login') {
    def docker = new com.iti.docker()
    docker.login(USERNAME, DOCKER_CRED_ID)
 }

 stage("Docker Push") {
    def docker = new com.iti.docker()
    docker.push(IMAGE_NAME, IMAGE_TAG)
 }

// stage("Update ArgoCD Deployment") {
//     withCredentials([string(credentialsId: 'github-token', variable: 'GITHUB_TOKEN')]) {
//         // Update deployment file
//         sh "cd argocd && sed -i 's|image: muhammedhamed/java:v.*|image: ${IMAGE_NAME}:${IMAGE_TAG}|g' iti-dev/deployment.yaml"
        
//         // Configure git user
//         sh "git config user.email 'jenkins@example.com'"
//         sh "git config user.name 'Jenkins CI'"
        
//         // Add and commit changes
//         sh "git add argocd/iti-dev/deployment.yaml"
//         sh "git commit -m 'Update image tag to ${IMAGE_TAG} - Build #${BUILD_NUMBER}'"
        
//         // Push using token authentication
//         sh "git push https://${GITHUB_TOKEN}@github.com/muhammedhamedelgaml/java-app.git master"
//     }
// }


  
}
