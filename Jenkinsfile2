node {
    // Define tools
    def mvnHome = tool name: 'maven', type: 'maven'
    def jdkHome = tool name: 'jdk', type: 'jdk'

    // Set environment variables
    env.PATH = "${jdkHome}/bin:${env.PATH}"
    env.MAVEN_HOME = mvnHome
    env.JAVA_HOME = jdkHome
    env.DOCKER_PASS = credentials('dockerhub-pass')
    env.DOCKER_NAME = 'muhammedhamedelgaml'

    stage("Dependency check") {
        sh "${mvnHome}/bin/mvn dependency-check:check"
        dependencyCheckPublisher pattern: 'target/dependency-check-report.xml'
    }

    stage("Build app") {
        sh "${mvnHome}/bin/mvn package install"
    }

    stage("Archive app") {
        archiveArtifacts artifacts: '**/*.jar', followSymlinks: false
    }

    stage("Docker build") {
        sh "docker build -t ${env.DOCKER_NAME}/iti-java:v${env.BUILD_NUMBER} ."
        sh "docker images"
    }

    stage("Docker push") {
        sh "echo ${env.DOCKER_PASS} | docker login -u ${env.DOCKER_NAME} --password-stdin"
        sh "docker push ${env.DOCKER_NAME}/iti-java:v${env.BUILD_NUMBER}"
    }
}
